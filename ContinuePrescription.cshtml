@model PrescribingSystem.Models.ViewModels.ContinuePrescriptionViewModel
@{
    Layout = "_PharmacistLayout";
}

<div class="container p-4">
    <h3 class="mb-3">Script #@Model.PrescriptionId : @Model.CustomerName</h3>

    <div class="row">
        <!-- Prescription Info -->
        <div class="col-md-8">
            <div class="mb-3">
                <strong>Customer:</strong> @Model.CustomerName <br />
                <strong>Doctor:</strong> @Model.DoctorName <br />
                <strong>Prescription #:</strong> @Model.PrescriptionId <br />
                <strong>Status:</strong> <span class="badge bg-info text-dark">@Model.Status</span> <br />
                <strong>Last Updated:</strong> @(Model.LastUpdated?.ToString("dd MMM yyyy HH:mm") ?? "Not updated")
            </div>

            <form id="repeatRequestForm" asp-action="ContinuePrescription" method="post">
                <input type="hidden" asp-for="PrescriptionId" />
                <input type="hidden" name="action" id="formAction" value="" />

                <p class="text-muted mb-2">
                    <small>
                        Select dispensed medications to request a repeat. Pending medications cannot be requested.
                    </small>
                </p>

                <table class="table table-bordered align-middle">
                    <thead class="table-primary">
                        <tr>
                            <th>Select</th>
                            <th>Medication</th>
                            <th>Quantity</th>
                            <th>Instructions</th>
                            <th>Repeats Left</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var med in Model.Medications)
                        {
                            bool isDispensed = med.Status == MedicationStatus.Dispensed;
                            bool canRequestRepeat = isDispensed && med.RepeatsLeft > 0;

                            <tr class="@(isDispensed ? "table-success" : "")">
                                <td>
                                    <input type="checkbox"
                                           name="SelectedMedicationIds"
                                           value="@med.MedicationPrescriptionId" />
                                </td>
                                <td>@med.MedicationName</td>
                                <td>@med.Quantity</td>
                                <td>@med.Instructions</td>
                                <td>@med.RepeatsLeft</td>
                                <td>
                                    @if (med.Status == MedicationStatus.Dispensed)
                                    {
                                        <span class="badge bg-success">Dispensed</span>
                                        @*  <input type="checkbox" checked disabled />
                                        <input type="hidden" name="SelectedMedicationIds" value="@med.MedicationPrescriptionId" /> *@
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">Pending</span>
                                        @*  <input type="checkbox" name="SelectedMedicationIds" value="@med.MedicationPrescriptionId" /> *@
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <div class="mt-3">
                 @*    <button type="button" id="confirmRepeatBtn" name="action" value="repeat" class="btn btn-outline-primary">Request Repeat</button> *@
                    <button type="submit" class="btn btn-primary">Dispense Selected</button>
                    <a asp-action="SavedPrescriptions" class="btn btn-secondary">Back</a>
                </div>
            </form>
        </div>

        <!-- Prescription File Preview -->
        <div class="col-md-4">
            <h5>Prescription Document</h5>
            @if (!string.IsNullOrEmpty(Model.PrescriptionFileUrl))
            {
                <iframe src="@Model.PrescriptionFileUrl" width="100%" height="400px" class="border"></iframe>
            }
            else
            {
                <p class="text-muted">No document uploaded</p>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="confirmRepeatModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Repeat Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to request a repeat for the selected medication(s)?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="submitRepeatRequest">Yes, Confirm</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById("confirmRepeatBtn").addEventListener("click", function (event) {
            event.preventDefault();
            const checkboxes = document.querySelectorAll("input[name='SelectedMedicationIds']:checked");
            if (checkboxes.length === 0) {
                alert("Please select at least one medication to request a repeat.");
                return;
            }
            const modal = new bootstrap.Modal(document.getElementById("confirmRepeatModal"));
            modal.show();
        });

        document.getElementById("submitRepeatRequest").addEventListener("click", function () {
            document.getElementById("formAction").value = "repeat";
            document.getElementById("repeatRequestForm").submit();
        });
    </script>
}