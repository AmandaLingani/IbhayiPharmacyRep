@model PrescribingSystem.Models.ViewModels.ProcessPrescriptionViewModel

@{
    Layout = "_PharmacistLayout";
}

<div class="container-fluid py-4">

    <div class="row">
        <div class="col-12 mb-3 d-flex justify-content-between align-items-center">
            <h2 class="fw-bold">
                <i class="bi bi-capsule me-2"></i> Process Prescription
            </h2>

            <button type="button" class="btn btn-outline-secondary" onclick="togglePreview()">
                <i class="bi bi-file-earmark-medical me-1"></i> Preview Script
            </button>
        </div>
    </div>

    <!-- Status Badges -->
    <div class="mb-3">
        @if (Model.WantsDispense)
        {
            <span class="badge bg-success me-2">
                <i class="bi bi-check-circle-fill me-1"></i> Dispense Requested
            </span>
        }
        else
        {
            <span class="badge bg-secondary me-2">
                <i class="bi bi-pause-circle me-1"></i> Save Only
            </span>
        }

    </div>

    <div class="row">
        <!-- Left Column (Form) -->
        <div id="formColumn" class="col-lg-7 col-md-12 transition">
            <form asp-action="ProcessPrescription" method="post" class="bg-white shadow rounded p-4">
                <input type="hidden" asp-for="PrescriptionId" />
                <input type="hidden" asp-for="CustomerId" />
                <input type="hidden" asp-for="CustomerName" />
                <input type="hidden" asp-for="IdentityNumber" />
                <input type="hidden" asp-for="WantsDispense" />
                <input type="hidden" asp-for="PrescriptionFileUrl" />
                <input type="hidden" asp-for="LastUpdated" />
                <input type="hidden" id="removedMedicationIds" name="RemovedMedicationIds" />

                @if (Model.HasAllergyWarning)
                {
                    <div class="alert alert-warning mt-3">
                        This customer is allergic to one or more ingredients in the selected medication.
                        <br />
                        <label class="mt-2">
                            <input type="checkbox" id="overrideCheckbox" asp-for="OverrideAllergyConfirmed" />
                            I have reviewed this warning and choose to override.
                        </label>
                        <br />
                        <textarea asp-for="OverrideReason" class="form-control mt-2" placeholder="Reason for override (required)" disabled></textarea>
                        <span asp-validation-for="OverrideReason" class="text-danger"></span>
                    </div>
                }

                <!-- Customer Info -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Customer:</label>
                        <input type="text" class="form-control" value="@Model.CustomerName" readonly />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Identity Number:</label>
                        <input asp-for="IdentityNumber" type="text" class="form-control" readonly />
                    </div>
                </div>

                <!-- Doctor Selection -->
                <div class="mb-3">
                    <label class="form-label">Prescribed By</label>
                    <select class="form-select" asp-for="SelectedDoctorId"
                            asp-items="@(Model.Doctors?.Select(d=> new SelectListItem
                            {
                                Value = d.DoctorId.ToString(),
                                Text = $"Dr. {d.Name} {d.Surname}"
                            }))">
                        <option value="">Select Doctor</option>
                    </select>
                    <button type="button" class="btn btn-outline-primary" id="AddNewDoctor">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>

                <!-- Add Medication Inputs -->
                <h5 class="mt-4">Add Medication</h5>
                @if (Model.Medications != null && Model.Medications.Any())
                {
                    @for (int i = 0; i < Model.Medications.Count; i++)
                    {
                        <input type="hidden" asp-for="Medications[@i].MedicationId" />
                        <input type="hidden" asp-for="Medications[@i].MedicationName" />
                        <input type="hidden" asp-for="Medications[@i].Quantity" />
                        <input type="hidden" asp-for="Medications[@i].Instructions" />
                        <input type="hidden" asp-for="Medications[@i].RepeatsLeft" />
                    }
                }

                <div class="row mb-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Medication</label>
                        <select asp-for="NewMedications.MedicationId" class="form-select select2">
                            <option value="">Select</option>
                            @foreach (var med in Model.MedicationsList)
                            {
                                <option value="@med.MedicationId">@med.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Qty</label>
                        <input asp-for="NewMedications.Quantity" type="number" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Instructions</label>
                        <input asp-for="NewMedications.Instructions" type="text" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Repeats</label>
                        <input asp-for="NewMedications.RepeatsLeft" type="number" class="form-control" min="0" />
                    </div>
                    <div class="col-md-2 d-grid mt-3">
                        <button type="submit" name="action" value="add" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i> Add
                        </button>
                    </div>
                </div>


                <div class="table-responsive mt-4">
                    <table class="table table-bordered align-middle">

                        <thead class="table-light">
                            <tr>
                                <th>Medication</th>
                                <th>Quantity</th>
                                <th>Instructions</th>
                                <th>Repeats Left</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Medications != null)
                            {
                                @for (int i = 0; i < Model.Medications.Count; i++)
                                {
                                    <tr>
                                        <td>
                                            @Model.Medications[i].MedicationName
                                            <input type="hidden" name="Medications[@i].MedicationId" value="@Model.Medications[i].MedicationId" />
                                            <input type="hidden" name="Medications[@i].MedicationName" value="@Model.Medications[i].MedicationName" />
                                            <input type="hidden" name="Medications[@i].Quantity" value="@Model.Medications[i].Quantity" />
                                            <input type="hidden" name="Medications[@i].Instructions" value="@Model.Medications[i].Instructions" />
                                            <input type="hidden" name="Medications[@i].RepeatsLeft" value="@Model.Medications[i].RepeatsLeft" />
                                        </td>
                                        <td>@Model.Medications[i].Quantity</td>
                                        <td>@Model.Medications[i].Instructions</td>
                                        <td>@Model.Medications[i].RepeatsLeft</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="removeMedicationRow(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }

                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button type="submit" name="action" value="save" class="btn btn-dark me-2">Save</button>
                    <button type="submit" name="action" value="dispense" class="btn btn-success">Dispense</button>
                    <a asp-action="CustomerPrescriptions" class="btn btn-secondary">Back</a>
                </div>
            </form>
        </div>


        <div id="prescriptionPreview" class="col-lg-5 col-md-12 transition" style="display:none;">
            <div class="bg-white shadow rounded p-3 h-100">
                <h5 class="mb-3">Prescription Preview</h5>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="zoomOut()">➖</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="zoomIn()">➕</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetZoom()">🔄</button>
                </div>
                <div id="previewContainer" style="overflow:auto; width:100%; height:600px; position:relative;">
                    @if (!string.IsNullOrEmpty(Model.PrescriptionFileUrl))
                    {
                        <iframe id="pdfPreview"
                                src="@Url.Content(Model.PrescriptionFileUrl)"
                                style="border: 1px solid #ddd; border-radius: 8px; width:100%; height:100%;">
                        </iframe>
                    }
                    else
                    {
                        <p class="text-muted">No prescription file uploaded.</p>
                    }
                </div>
            </div>
        </div>
        @await Html.PartialAsync("_DoctorModal", Model.NewDoctor);
    </div>
</div>

<!-- Dispense Confirmation Modal -->
<div class="modal fade" id="dispenseConfirmModal" tabindex="-1" aria-labelledby="dispenseConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="dispenseConfirmLabel"><i class="bi bi-check2-circle me-2"></i>Confirm Dispense</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p>Are you sure you want to dispense this prescription?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitForm('dispense')">Yes, Dispense</button>
            </div>
        </div>
    </div>
</div>


<!-- Dispense Confirmation Modal -->
<div class="modal fade" id="dispenseConfirmModal" tabindex="-1" aria-labelledby="dispenseConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="dispenseConfirmLabel"><i class="bi bi-check2-circle me-2"></i>Confirm Dispense</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p>Are you sure you want to dispense this prescription?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitForm('dispense')">Yes, Dispense</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
           function togglePreview() {
            const previewDiv = document.getElementById("prescriptionPreview");
            const formContainer = document.getElementById("prescriptionFormContainer");

            if (previewDiv.style.display === "none" || previewDiv.style.display === "") {
                previewDiv.style.display = "block";
                formContainer.classList.add("me-3");
            } else {
                previewDiv.style.display = "none";
                formContainer.classList.remove("me-3");
            }
        }

          document.getElementById("AddNewDoctor").addEventListener("click", function () {
            var modal = new bootstrap.Modal(document.getElementById("addDoctorModal"));
            modal.show();
           });

                let zoomLevel = 1;

        window.zoomIn = function () {
            zoomLevel += 0.1;
            applyZoom();
        };

        window.zoomOut = function () {
            if (zoomLevel > 0.2) { // prevent too small
                zoomLevel -= 0.1;
                applyZoom();
            }
        };

        window.resetZoom = function () {
            zoomLevel = 1;
            applyZoom();
        };

        function applyZoom() {
            const pdfPreview = document.getElementById("pdfPreview");
            if (pdfPreview.style.display === "block") {
                pdfPreview.style.transform = `scale(${zoomLevel})`;
                pdfPreview.style.transformOrigin = "top left";
            }
        }

                      function removeMedicationRow(button) {
            try {
                const row = button.closest("tr");
                if (!row) return;

                if (!confirm("Remove this medication?")) return;

                const medIdInput = row.querySelector("input[name*='MedicationId']");
        const medId = medIdInput ? medIdInput.value : null;

        // Update hidden field
        if (medId) {
            const hiddenField = document.getElementById("removedMedicationIds");
            let removedIds = hiddenField.value ? hiddenField.value.split(",") : [];
            if (!removedIds.includes(medId)) {
                removedIds.push(medId);
                hiddenField.value = removedIds.join(",");
            }
        }

                // Remove the row visually
                row.remove();

                // Reindex all remaining rows safely
                reindexMedicationRows();
            } catch (err) {
                console.error("Error removing medication row:", err);
            }
        }

        function reindexMedicationRows() {
            try {
                const table = document.querySelector("table.table tbody");
                if (!table) return;

                const rows = table.querySelectorAll("tr");

                rows.forEach((row, index) => {
                    const inputs = row.querySelectorAll("input[name^='Medications']");
                    inputs.forEach(input => {
                        // Update each input name to the correct new index
                        input.name = input.name.replace(/Medications\[\d+\]/, `Medications[${index}]`);
                    });
                });
            } catch (err) {
                console.error("Error reindexing medication rows:", err);
            }
        }

        // Ensure reindexing happens right before form submission
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.querySelector("form");
            if (!form) return;

            form.addEventListener("submit", () => {
                reindexMedicationRows();
            });
        });

              document.addEventListener("DOMContentLoaded", function () {
            const checkbox = document.getElementById("overrideCheckbox");
            const reasonBox = document.querySelector("textarea[name='OverrideReason']");
            const dispenseBtn = document.querySelector("button[name='action'][value='dispense']");

            if (!checkbox || !reasonBox || !dispenseBtn) return;

            function updateDispenseState() {
                const enabled = checkbox.checked && reasonBox.value.trim() !== "";
                dispenseBtn.disabled = !enabled;
                reasonBox.disabled = !checkbox.checked;
            }

            checkbox.addEventListener("change", updateDispenseState);
            reasonBox.addEventListener("input", updateDispenseState);

            updateDispenseState();
        });

         document.addEventListener("DOMContentLoaded", function () {
            // Detect if this is a postback from the "add" action
            const urlParams = new URLSearchParams(window.location.search);
            const isAddAction = document.querySelector("input[name='action'][value='add']");

            // You can check hidden inputs or action name if needed
            const addWasClicked = sessionStorage.getItem("addedMedication") === "true";

            if (addWasClicked) {
                document.querySelector("select[name='NewMedications.MedicationId']").value = "";
                document.querySelector("input[name='NewMedications.Quantity']").value = "";
                document.querySelector("input[name='NewMedications.Instructions']").value = "";
                document.querySelector("input[name='NewMedications.RepeatsLeft']").value = "";
                sessionStorage.removeItem("addedMedication");
            }

            const addBtn = document.querySelector("button[name='action'][value='add']");
            if (addBtn) {
                addBtn.addEventListener("click", () => {
                    sessionStorage.setItem("addedMedication", "true");
                });
            }
        });

        function submitForm(action) {
            const form = document.getElementById("processForm");
            if (!form) return;

            const actionInput = document.createElement("input");
            actionInput.type = "hidden";
            actionInput.name = "action";
            actionInput.value = action;

            form.appendChild(actionInput);
            form.submit();
        }

    </script>
}

<style>
    /* Smooth transition effect */
    .transition {
        transition: all 0.3s ease-in-out;
    }

    #prescriptionPreview {
        z-index: 0 !important;
    }

</style>


